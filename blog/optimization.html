<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>性能优化 | 前端日志</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="欢迎访问我的前端日志">
    
    <link rel="preload" href="/assets/css/0.styles.e1700646.css" as="style"><link rel="preload" href="/assets/js/app.a0896f0e.js" as="script"><link rel="preload" href="/assets/js/2.88eb2c00.js" as="script"><link rel="preload" href="/assets/js/24.670dab57.js" as="script"><link rel="prefetch" href="/assets/js/10.d30f3d8f.js"><link rel="prefetch" href="/assets/js/11.e2b957ff.js"><link rel="prefetch" href="/assets/js/12.2da1d6bb.js"><link rel="prefetch" href="/assets/js/13.8ce2c088.js"><link rel="prefetch" href="/assets/js/14.16109f84.js"><link rel="prefetch" href="/assets/js/15.93448cfb.js"><link rel="prefetch" href="/assets/js/16.6f18825f.js"><link rel="prefetch" href="/assets/js/17.be1e4a31.js"><link rel="prefetch" href="/assets/js/18.e635c0f4.js"><link rel="prefetch" href="/assets/js/19.be17ff30.js"><link rel="prefetch" href="/assets/js/20.d142b0c9.js"><link rel="prefetch" href="/assets/js/21.e40d6d09.js"><link rel="prefetch" href="/assets/js/22.071940ae.js"><link rel="prefetch" href="/assets/js/23.99088ae7.js"><link rel="prefetch" href="/assets/js/25.85694927.js"><link rel="prefetch" href="/assets/js/26.461dcdb2.js"><link rel="prefetch" href="/assets/js/27.878ab7f9.js"><link rel="prefetch" href="/assets/js/28.1fcc3f4d.js"><link rel="prefetch" href="/assets/js/29.86923448.js"><link rel="prefetch" href="/assets/js/3.037aac60.js"><link rel="prefetch" href="/assets/js/30.724a5ac7.js"><link rel="prefetch" href="/assets/js/31.ac601726.js"><link rel="prefetch" href="/assets/js/32.765bf8d3.js"><link rel="prefetch" href="/assets/js/33.509ffbda.js"><link rel="prefetch" href="/assets/js/34.5aa96cf1.js"><link rel="prefetch" href="/assets/js/35.f1909c5d.js"><link rel="prefetch" href="/assets/js/36.36538350.js"><link rel="prefetch" href="/assets/js/37.b9375bb3.js"><link rel="prefetch" href="/assets/js/38.193abee5.js"><link rel="prefetch" href="/assets/js/39.b584d1b5.js"><link rel="prefetch" href="/assets/js/4.a0809240.js"><link rel="prefetch" href="/assets/js/40.17832949.js"><link rel="prefetch" href="/assets/js/41.cde349a4.js"><link rel="prefetch" href="/assets/js/42.67b16448.js"><link rel="prefetch" href="/assets/js/43.1b5d99f6.js"><link rel="prefetch" href="/assets/js/44.9ecb1424.js"><link rel="prefetch" href="/assets/js/5.77c6fbd3.js"><link rel="prefetch" href="/assets/js/6.609d5ed0.js"><link rel="prefetch" href="/assets/js/7.9131668e.js"><link rel="prefetch" href="/assets/js/8.f1d4a37a.js"><link rel="prefetch" href="/assets/js/9.8be87860.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e1700646.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/combat/" class="nav-link">
  实战
</a></div><div class="nav-item"><a href="/book/" class="nav-link">
  阅读
</a></div><div class="nav-item"><a href="https://github.com/wumao016" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/combat/" class="nav-link">
  实战
</a></div><div class="nav-item"><a href="/book/" class="nav-link">
  阅读
</a></div><div class="nav-item"><a href="https://github.com/wumao016" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>DevOps</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/php.html" class="sidebar-link">工具的安装</a></li><li><a href="/blog/php1.html" class="sidebar-link">PHP</a></li><li><a href="/blog/node.html" class="sidebar-link">Node.js</a></li><li><a href="/blog/webpack.html" class="sidebar-link">Webpack 使用</a></li><li><a href="/blog/gulp.html" class="sidebar-link">构建工具和脚手架</a></li><li><a href="/blog/optimization.html" aria-current="page" class="active sidebar-link">性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/optimization.html#雅虎军规" class="sidebar-link">雅虎军规</a></li><li class="sidebar-sub-header"><a href="/blog/optimization.html#面向切面编程" class="sidebar-link">面向切面编程</a></li><li class="sidebar-sub-header"><a href="/blog/optimization.html#chrome调试" class="sidebar-link">Chrome调试</a></li><li class="sidebar-sub-header"><a href="/blog/optimization.html#浏览器基础概念" class="sidebar-link">浏览器基础概念</a></li><li class="sidebar-sub-header"><a href="/blog/optimization.html#现代浏览器渲染过程" class="sidebar-link">现代浏览器渲染过程</a></li><li class="sidebar-sub-header"><a href="/blog/optimization.html#h5性能优化" class="sidebar-link">H5性能优化</a></li></ul></li><li><a href="/blog/nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/blog/engineering.html" class="sidebar-link">前端工程化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Framework</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/express.html" class="sidebar-link">Express</a></li><li><a href="/blog/koa1.html" class="sidebar-link">Koa</a></li><li><a href="/blog/vue.html" class="sidebar-link">VUE 源码</a></li><li><a href="/blog/react.html" class="sidebar-link">React 使用</a></li><li><a href="/blog/uniapp.html" class="sidebar-link">Uni-app使用</a></li><li><a href="/blog/ts.html" class="sidebar-link">TS 使用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/css-3d.html" class="sidebar-link">CSS使用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/es5.html" class="sidebar-link">ES5.1</a></li><li><a href="/blog/es6.html" class="sidebar-link">ES6</a></li><li><a href="/blog/javascript-QA.html" class="sidebar-link">Javascript与QA工程师</a></li><li><a href="/blog/js.html" class="sidebar-link">JavaScript 精粹</a></li><li><a href="/blog/js-function.html" class="sidebar-link">函数式编程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其它</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/html.html" class="sidebar-link">同源和跨域</a></li><li><a href="/blog/http.html" class="sidebar-link">HTTP</a></li><li><a href="/blog/write.html" class="sidebar-link">手写函数</a></li><li><a href="/blog/test.html" class="sidebar-link">习题总结</a></li><li><a href="/blog/arithmetic.html" class="sidebar-link">算法</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="性能优化"><a href="#性能优化" class="header-anchor">#</a> 性能优化</h1> <h2 id="雅虎军规"><a href="#雅虎军规" class="header-anchor">#</a> 雅虎军规</h2> <p>web前端性能的优化，要提到雅虎军规35条，虽然有点老，但要了解。<a href="https://www.cnblogs.com/xianyulaodi/p/5755079.html" target="_blank" rel="noopener noreferrer">解释地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="面向切面编程"><a href="#面向切面编程" class="header-anchor">#</a> 面向切面编程</h2> <p>面向切面编程，简称AOP，AOP主要实现的目的是针对业务处理过程中的切面进行提取，它所面对的是处理过程中的某个步骤或阶段，以获得逻辑过程中各部分之间低耦合性的隔离效果。</p> <p>代码案例</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//要统计一下当前的所有的函数谁耗时最长</span>
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token string">&quot;test&quot;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">before</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> __self<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//this指向调用函数</span>
		<span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">__self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>__self<span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">after</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> __self<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">var</span> result<span class="token operator">=</span><span class="token function">__self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>__self<span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token keyword">return</span> result
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//挂载 self-&gt;test 执行before回调 执行self after 自己执行回调</span>
test<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="chrome调试"><a href="#chrome调试" class="header-anchor">#</a> Chrome调试</h2> <h3 id="断点和捕获事件绑定"><a href="#断点和捕获事件绑定" class="header-anchor">#</a> 断点和捕获事件绑定</h3> <ul><li>断点 sources面板，打开一个文件，点前面的行数就可是设置断点，点右侧的向下的箭头和跳转箭头，就可以向下走和跳出当前函数。</li> <li>捕获事件绑定 elements面板，右侧的event listenters，选中一个元素，就可以看到绑定的事件</li></ul> <h3 id="其他面板"><a href="#其他面板" class="header-anchor">#</a> 其他面板</h3> <ul><li>Audits面板 也是能直观的看到性能需要优化的点，不过我现在找不到这个面板了</li> <li>PerformanceTracer插件 需要在chrome商城下载</li> <li>Page Speed插件 需要在chrome商城下载</li> <li>performance.timing chrome的api，直接能反映出来一个请求过程中，各个阶段的时间</li></ul> <h3 id="timeline帧渲染模式"><a href="#timeline帧渲染模式" class="header-anchor">#</a> Timeline帧渲染模式</h3> <p><strong>基础概念</strong></p> <ul><li><p>网页动画能够做到每秒60帧，就会跟显示器同步刷新，一秒之内进行60次重新渲染，每次重新渲染的时间不能超过16,66毫秒</p></li> <li><p>黄色：JavaScript执行</p></li> <li><p>紫色：样式计算和布局，即重排</p></li> <li><p>绿色：重绘</p></li> <li><p>可以根据 performance面板来录制</p></li> <li><p>跟帧相关的API  window.requestAnimationFrame() // 下一次</p></li> <li><p>window.requestldleCallback() // 下几次重新渲染时</p></li> <li><p>网页是分层的，触发分层的过程是：</p> <ul><li>1.获取DOM并将其分割为多个层</li> <li>2.将每个层独立的绘制进位图中</li> <li>3.将层作为纹理上传至GPU</li> <li>4.复合多个层来生成最终的屏幕图像
<strong>触发分层</strong></li></ul></li> <li><p>DOM子树渲染层(RenderLayer)-&gt; RenderObject -&gt; GraphicsContext (根元素、position、transform、半透明、css滤镜、Canvas2D、video、溢出)</p></li> <li><p>Compositor -&gt; 渲染层子树的图形层（GraphicsLayer）-&gt; RenderLayer -&gt; RenderObject .(Compositor将所有的拥有compositing layer进行合成，合成过程GPU进行
参与。合成完毕就能够将纹理映射到一个网格几何结构之上--在视频游戏或者CAD程序中，这种技术用来给框架式的3D模型添加“皮肤”。Chrome采用纹理把页面中的内容分块发送给GPU。纹理
能够以很低的代价映射到不同的位置，而且还能够以很低的代价通过把它们应用到一个非常简单的矩形网格中进行变形。这就是3D CSS的实现原理)(
CSS3D透视变换、video、webgl、transform动画、加速CSS滤镜、叠加在已经触发合成层)</p></li></ul> <p><strong>如何尽量避免重排</strong></p> <ul><li>样式表越简单，重排和重绘就越快</li> <li>重排和重绘的DOM元素层级越高，成本就越高</li> <li>table元素重排和重绘成本高于div</li> <li>尽量不要把读操作和写操作，放在一个语句里面</li> <li>统一改变样式</li> <li>缓存重排结果</li> <li>离线DOM Fragment/clone</li> <li>虚拟DOM React</li> <li>必要的时候 dispaly：none不影响重排和重绘。visibility对重排影响不影响重绘</li></ul> <h3 id="profiles分析"><a href="#profiles分析" class="header-anchor">#</a> Profiles分析</h3> <p><strong>观察nodejs内存泄露</strong></p> <p>Memory-&gt;Profiles面板在chrome上可以直观的看到内存的使用情况，在node上也有类似的。比如我启动一个node服务，然后输入 node-inspector,
会输出一个地址，打开这个地址就可以看到类似于Profiles的界面，更加直观检测node内存泄露等问题，比较高效。</p> <h3 id="高性能动画及渲染原理"><a href="#高性能动画及渲染原理" class="header-anchor">#</a> 高性能动画及渲染原理</h3> <p><strong>如何实现动画</strong></p> <ul><li>jquery animation：setTimeout,top/left</li> <li>animation,transition,transform</li> <li>js+canvas/WebGL/SVG</li> <li>requestAnimationFrame</li> <li>GPU硬件加速</li></ul> <h2 id="浏览器基础概念"><a href="#浏览器基础概念" class="header-anchor">#</a> 浏览器基础概念</h2> <h3 id="浏览器渲染过程"><a href="#浏览器渲染过程" class="header-anchor">#</a> 浏览器渲染过程</h3> <ul><li>处理流程：</li> <li>1、输⼊⽹址并回车</li> <li>2、解析域名</li> <li>3、浏览器发送HTTP请求</li> <li>4、服务器处理请求</li> <li>5、服务器返回HTML响应</li> <li>6、浏览器处理HTML页⾯</li> <li>7、继续请求其他资源
<img src="opt_1.png" alt="浏览器">
上图就更形象的解释了浏览器渲染的过程，而下图是更加细化的描述过程，也更加重要。
<img src="opt_2.png" alt="浏览器">
简单概括一下过程：</li> <li>第一步Prompt for unload，是提示卸载，就相当于打开一个页面的一瞬间；</li> <li>第二步 redirect，是重定向，相当于找本地的缓存过程，这个过程还有一个动作 unload，是为了把上一个页面卸载掉；</li> <li>第三步 app cache，如果第二步中有缓存的话（强制缓存），才走这一步，可以节省带宽，没有就会跳过这一步，如果有缓存就会直接跳到processing，前三步属于浏览器本地，后面就开始进入到网络。</li> <li>然后 DNS、TCP、Request、Response 是属于网络方面的后面Processing、onLoad又回到CPU上。在TCP走向Req的过程，就开始http请求了，在req到res这个节点，就是服务器开始响应的节点。</li> <li>响应完然后到浏览器这边，Processing是在处理DOM，这里会有一段响应时间，来解析各种事件（比如onclick事件，如果是外部引用，这里可能是一个空引用，如果是写在页面里，这里就是有指向的）。</li> <li>最后就是onload，渲染到显示器上面。</li></ul> <p>简单总结：整个过程可以分为三个阶段，本地-》网络-》本地，第一部分是处理资源，第二部分是拿资源，第三部分是渲染新的资源。</p> <p>在图中有很多箭头指向的API，这些操作可以计算出各步骤都花费多长时间，这里先不多讲，后面再说。<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming" target="_blank" rel="noopener noreferrer">API地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>介绍这个过程，主要是为了性能优化</p> <ul><li>1.在redirect上两个API之间的时间，就是能优化的一点。</li> <li>2.发生网络重定向进入到DNS，本地重定向到app cache。
如果是本地缓存，记录这个拿缓存多少时间，是能优化的第二点，这点上我们可做的是减少磁盘在资源上操作的次数。</li> <li>3.DNS上可优化的，CDN</li> <li>4.TCP上，第一，可以加带宽。第二，优化服务器（比如nodejs）。</li> <li>5.res上两个节点，会把服务器处理的时间算上。在文件上可以把文件做小来优化。</li></ul> <h3 id="dns详解"><a href="#dns详解" class="header-anchor">#</a> DNS详解</h3> <ul><li>DNS 是Domain Name System, 域名系统，⽤于将域名转换为IP。</li> <li>顶级域名
<ul><li>域名主要看后缀，紧挨着后缀的是一级域名，再往前就是二级域名，依次类推。（www也算是）</li></ul></li> <li>域名资源记录
<img src="opt_8.png" alt="DNS"></li> <li>域名服务器</li> <li>域名解析</li></ul> <h3 id="tcp三次握手与四次挥手"><a href="#tcp三次握手与四次挥手" class="header-anchor">#</a> TCP三次握⼿与四次挥⼿</h3> <p><img src="opt_3.png" alt="TCP">
上图，是TCP协议头的封装，至少要二十个字节，首先是两个端口，一个是发送方的端口，一个是接收的端口；然后是顺序号，占四个字节；
接下来是应答号，是要对应顺序号的；然后是偏移量，标记，校验号，TCP控制选项等等。
<img src="opt_4.png" alt="TCP">
这张图，就是讲三次握⼿与四次挥⼿的过程，TCP是可靠的协议，所谓可靠就是要保证接收端能接收到。看这张图，
首先，客户端发起请求，SYN指令，seq是一个顺序号，服务端一直在打开一个端口监听；服务端监听到后响应，发送SYN包，有响应号，有应答号，应答号是顺序号+1；
此时客户端处于一个半连接状态，在收到服务端的应答包后，返回给服务器端一个包，通知服务器端应答包已收到，所以ACK就是y+1，这是三次握手。接下来是传输过程，传输过程是来回多次的，
图中只画了一次。然后是四次挥手，一般来说断开链接，是由客户端主动断开的，是正常情况的，也有服务端主动断开的，一般是超时；客户端发送
断开指令，然后客户端这边响应接到指令，但客户端这边有可能有工作没干完，所以等完成后再发送一个包给客户端，所以响应和完成后再发送这两个步骤是单独的，不能合并；最后客户端在发送一个包，表示已经收到了，链接才算真正的断开了。</p> <h3 id="cdn概念"><a href="#cdn概念" class="header-anchor">#</a> CDN概念</h3> <p><img src="opt_5.png" alt="CDN"></p> <h3 id="缓存机制"><a href="#缓存机制" class="header-anchor">#</a> 缓存机制</h3> <p>缓存会根据请求保存输出内容的副本，例如html页⾯，图⽚，⽂
件，当下⼀个请求来到的时候：如果是相同的URL，缓存直接使
⽤副本响应访问请求，⽽不是向源服务器再次发送请求。</p> <ul><li>缓存的优点：</li> <li>减少相应延迟</li> <li>减少⽹络带宽消耗</li></ul> <h3 id="浏览器缓存机制-浏览器第一次请求"><a href="#浏览器缓存机制-浏览器第一次请求" class="header-anchor">#</a> 浏览器缓存机制－浏览器第⼀次请求</h3> <p><img src="opt_6.png" alt="缓存"></p> <h3 id="浏览器缓存机制-浏览器再次请求"><a href="#浏览器缓存机制-浏览器再次请求" class="header-anchor">#</a> 浏览器缓存机制－浏览器再次请求</h3> <p><img src="opt_7.png" alt="缓存"></p> <h3 id="etag-if-none-match策略"><a href="#etag-if-none-match策略" class="header-anchor">#</a> Etag/If-None-Match策略</h3> <ul><li>Etag： web服务器响应请求时，告诉浏览器当前资源在服务器
的唯⼀标识（⽣成规则由服务器决定）</li> <li>If-None-Match：当资源过期时（使⽤Cache-Control标识的maxage），发现资源具有Etage声明，则再次向web服务器请求时带
上头If-None-Match （Etag的值）。 web服务器收到请求后发现
有头If-None-Match 则与被请求资源的相应校验串进⾏⽐对，决
定返回200或304。</li></ul> <h3 id="last-modified-if-modified-since策略"><a href="#last-modified-if-modified-since策略" class="header-anchor">#</a> Last-Modified/If-Modified-Since策略</h3> <ul><li>Last-Modified：标⽰这个响应资源的最后修改时间。 web服务器在响应请求
时，告诉浏览器资源的最后修改时间。</li> <li>If-Modified-Since：当资源过期时（使⽤Cache-Control标识的max-age），发
现资源具有Last-Modified声明，则再次向web服务器请求时带上头 IfModified-Since，表⽰请求时间。 web服务器收到请求后发现有头If-ModifiedSince 则与被请求资源的最后修改时间进⾏⽐对。若最后修改时间较新，说
明资源又被改动过，则响应整⽚资源内容（写在响应消息包体内）， HTTP
200；若最后修改时间较旧，说明资源⽆新修改，则响应HTTP 304 (⽆需包
体，节省浏览)，告知浏览器继续使⽤所保存的cache。</li></ul> <h2 id="现代浏览器渲染过程"><a href="#现代浏览器渲染过程" class="header-anchor">#</a> 现代浏览器渲染过程</h2> <ul><li><strong>浏览器的进化过程</strong> <ul><li>1990年，蒂姆·伯纳斯·李开发了第一个网页浏览器WorldWideWeb，后改名为Nexus。WorldWideWeb浏览器支持早期的HTML标记
语言，功能比较简单，只能支持文本、简单的样式表、电影、声音、图片等资源的显示。</li> <li>1993年，马克·安德森领导的团开发了一个真正有影响力的浏览器Mosaic，这就是后来世界上最流行的浏览器Netscape
Navigator。</li> <li>1995年，微软推出了闻名于世的浏览器Internet Explorer。 第一次浏览器大战开始，持续两年</li> <li>1998年，Netscape公司开放Netscape Navigator源代码，成立了Mozilla基金会。 第二次浏览器大战开始，持续八年</li> <li>2003年，苹果公司发布了Safari浏览器。</li> <li>2004年，Netscape公司发布了著名的开源浏览器Mozilla Firefox</li> <li>2005年，苹果公司开源了浏览器中的核心代码，基于此发起了一个新的开源项目WebKit（Safari浏览器的内核）。</li> <li>2008年， Google公司已WebKit为内核，创建了一个新的浏览器项目Chromium。以Chromium为基础，谷歌发布了Chrome浏览器。
至于这两者的关系，可以简单地理解为：Chromium为实验版，具有众多新特性；Chrome为稳定版。</li></ul></li> <li><strong>现代浏览器的特征与结构</strong> <ul><li>特征：
<ul><li>网络</li> <li>资源管理</li> <li>网页浏览</li> <li>多页面管理</li> <li>插件和扩展</li> <li>账户和同步</li> <li>安全机制</li> <li>开发者工具</li></ul></li> <li>结构：
<ul><li>用户界面（User Interface）</li> <li>浏览器引擎（Browser Engine）</li> <li>渲染引擎（Rendering Engine）</li> <li>网络（Networking）</li> <li>XML解析器（XML Parser）</li> <li>显示后端（Display Backend）</li> <li>数据持久层（Data Persistence）
<img src="opt_9.png" alt="结构"> <code>渲染引擎结构与工作流程:</code> <img src="opt_10.png" alt="结构与工作流程">以HTML/JavaScript/CSS等文件作为输入，以可视化内容作为输出</li></ul></li></ul></li> <li><strong>Chrome 浏览器架构</strong> <ul><li>Browser：控制程序的“chrome”部分，包括地
址栏，书签，后退和前进按钮。还处理Web浏
览器的不可见的，和特权部分，例如网络请求
和文件访问。</li> <li>Renderer：负责显示网站的选项卡内的所有内
容。</li> <li>Plugin：控制网站使用的所有插件，例如
flash。</li> <li>GPU：独立于其他进程的GPU处理任务。 它被
分成多个不同的进程，因为GPU处理来自多个
程序的请求并将它们绘制在同一个面中。
<img src="opt_11.png" alt="架构"></li></ul></li> <li><strong>Chrome 浏览器的渲染过程</strong> <ul><li>Chrome 渲染器进程
<ul><li>渲染器进程负责选项卡内发生的所有事情。 在
渲染器进程中，主线程处理你为用户编写的大
部分代码。</li> <li>如果你使用了web worker 或 service worker，
有时JavaScript代码的一部分将由工作线程处
理。 排版和栅格线程也在渲染器进程内运行，
以便高效、流畅地呈现页面。
<img src="opt_12.png" alt="进程"></li></ul></li> <li>Chrome 渲染过程：解析部分
<ul><li>构建DOM
<img src="opt_13.png" alt="解析"></li> <li>子资源加载(注意JavaScript可以阻止解析)</li> <li>提示浏览器如何加载资源</li> <li>样式表计算
<img src="opt_14.png" alt="渲染树"></li> <li>布局
<img src="opt_15.png" alt="绘制"></li> <li>绘制</li></ul></li> <li>Chrome 渲染过程：合成部分
<ul><li>把文档的结构、元素的样式、几何
形状和绘制顺序转换为屏幕上的像
素称为光栅化。</li> <li>合成是一种将页面的各个部分分
层，分别栅格化，并在一个被称为
合成器线程的独立线程中合成为页
面的技术。
<img src="opt_16.png" alt="layer tree"></li></ul></li> <li>Chrome 渲染过程：GPU渲染
<ul><li>一旦创建了层树并确定了绘制顺序，主线程就会将该信息提交给合
成器线程。 合成器线程然后栅格化每个图层。 一个图层可能像页
面的整个长度一样大，因此合成器线程会将它们分成图块，并将每
个图块发送到光栅线程。 栅格线程栅格化每一个tile并将它们存储
在GPU内存中。
<img src="opt_17.png" alt="渲染"></li> <li>通过IPC将合成器帧提交给浏览器进程。这时可以从UI线程添加另
一个合成器帧以用于浏览器UI更改，或者从其他渲染器进程添加扩
充数据。 这些合成器帧被发送到GPU用来在屏幕上显示。 如果发
生滚动事件，合成器线程会创建另一个合成器帧并发送到GPU。<img src="opt_18.png" alt="渲染"></li> <li>合成的好处是它可以在不涉及主线程的情况下完成。 合成线程不
需要等待样式计算或 JavaScript 执行。 这就是合成动画是平滑性
能的最佳选择的原因。 如果需要再次计算布局或绘图，则必须涉
及主线程。</li></ul></li></ul></li> <li><strong>初窥 WebKit</strong> <ul><li>WebKit 官网： https://webkit.org/</li> <li>Blink 是未来</li> <li>Blink官方文档： http://www.chromium.org/blink
<img src="opt_19.png" alt="webkit"></li></ul></li></ul> <h2 id="h5性能优化"><a href="#h5性能优化" class="header-anchor">#</a> H5性能优化</h2> <h3 id="初步优化"><a href="#初步优化" class="header-anchor">#</a> 初步优化</h3> <ul><li>雅⻁军规
<img src="opt_20.png" alt="雅⻁"> <ul><li>首先是HTML，要控制html的数量；善用css。</li> <li>压缩，压缩和合并要有一个指标来衡量，webpack默认的一种最佳的状态，小于30kb，不会导出一个单独的文件。
根据浏览器的特性，并发限制，请求最多在5个。</li> <li>CDN，比如请求5个达不到业务需求，把资源放到CDN上。还有一个使用CDN的好处，在页面上肯定是有cookie的，如果cookie太大，你访问这个域下的页面，这个cookie会一直带着，额外增加不必要的开销。</li> <li>网速，通过判断用户的网络类型（），来切换页面，有简版页面，模糊图页面。
<ul><li>移动网络测速的几种方法：</li> <li>1.H5天生属性，webkit和moz有connection（通过navigator.connection）但不是很准，移动端支持不是很好，如果不支持要设置connection.type=0。</li> <li>2.用一张图片去测速。</li> <li>3.多普勒测速,分5次请求计算。</li> <li>可以通过PerformanceTiming来得到各项指标。</li></ul></li> <li>离线缓存，localStorage 同步读取 5M，超过2.5M有些机型就卡了。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//伪代码</span>
<span class="token keyword">const</span> lists<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">&quot;main.js&quot;</span><span class="token operator">:</span><span class="token string">&quot;...md5.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;...mainmd5.js&quot;</span><span class="token operator">:</span><span class="token string">&quot;js&quot;</span>
    <span class="token comment">//把js成对存储</span>
<span class="token punctuation">}</span>
<span class="token comment">//启动脚本</span>
<span class="token keyword">const</span> __version<span class="token operator">=</span>localStorage<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>__version<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//缓存的比较</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lists<span class="token punctuation">[</span><span class="token string">&quot;main.js&quot;</span><span class="token punctuation">]</span><span class="token operator">==</span>__version<span class="token punctuation">)</span><span class="token punctuation">{</span>
  	  <span class="token function">addScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  	  localStorage<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	  localStorage<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">[</span>lists<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    __version<span class="token operator">=</span>lists<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//开始缓存</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span>__version<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  	  localStorage<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token operator">=</span>lists<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span>
  	  localStorage<span class="token punctuation">[</span>lists<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">=</span>data
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">addScript</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>src</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	  <span class="token keyword">return</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  	  <span class="token comment">//顶部追加script</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;main&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;${__version}&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></li> <li>缓存策略
<ul><li>缓存的优先级 cache-control&gt;expires&gt;etag&gt;last-modified
<img src="opt_21.png" alt="缓存"></li></ul></li> <li>⽹站协议
<img src="opt_22.png" alt="keep-alive"></li></ul> <h3 id="渲染中性能优化"><a href="#渲染中性能优化" class="header-anchor">#</a> 渲染中性能优化</h3> <ul><li>重绘影响</li> <li>重排影响</li></ul> <h3 id="⻚面加载性能优化"><a href="#⻚面加载性能优化" class="header-anchor">#</a> ⻚⾯加载性能优化</h3> <p><img src="opt_23.png" alt="指标"></p> <ul><li>页面加载性能指标
<ul><li>FP：仅有⼀个 div 根节点。</li> <li>FCP：包含⻚⾯的基本框架，但没有数据内容。</li> <li>FMP：包含⻚⾯所有元素及数据。</li></ul></li> <li>页面白屏原因
<ul><li>css&amp;js 文件获取</li> <li>js 文件解析</li> <li>dom 生成</li> <li>cssom 生成</li></ul></li> <li>VUE的执行
<img src="opt_24.png" alt="VUE"></li> <li>Long task
<img src="opt_25.png" alt="Long task"></li> <li>总结
<img src="opt_26.png" alt="总结"></li></ul> <h3 id="nodejs性能优化"><a href="#nodejs性能优化" class="header-anchor">#</a> NodeJS性能优化</h3> <ul><li>内存回收</li> <li>内存快照</li> <li>压力测试</li> <li>监控异常</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/gulp.html" class="prev">
        构建工具和脚手架
      </a></span> <span class="next"><a href="/blog/nginx.html">
        Nginx
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a0896f0e.js" defer></script><script src="/assets/js/2.88eb2c00.js" defer></script><script src="/assets/js/24.670dab57.js" defer></script>
  </body>
</html>
